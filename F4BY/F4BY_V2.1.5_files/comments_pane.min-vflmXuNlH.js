define(["require","exports","tslib","react","external/react-redux","modules/clean/account/email","modules/clean/account/email_verify_reasons","modules/clean/react/css","external/classnames","modules/core/i18n","modules/clean/auth/login_or_register/types","modules/clean/react_format","external/lodash","modules/constants/file_viewer","comments2/components/comment","comments2/components/comment_editor","comments2/components/comment_stream","comments2/components/coachmark_location","comments2/components/utils/guest_utils","modules/clean/react/comments2/actions_adapters/index","modules/clean/react/comments2/components/onboarding","modules/clean/react/comments2/components/coachmark","modules/clean/react/comments2/components/sidebar_listener","modules/clean/react/comments2/components/util","modules/clean/react/comments2/util","modules/clean/react/comments2/data/logger","modules/clean/react/comments2/data/types","modules/clean/react/comments2/transforms","modules/clean/react/comments2/data/actions","modules/clean/react/file_viewer/data/selectors","modules/clean/react/comments2/data/selectors","modules/clean/react/comments2/data/perf_util","modules/clean/react/comments2/data/mentions_api","modules/clean/previews/constants","modules/clean/react/comments2/components/comments_translations","modules/clean/react/comments2/components/tooltips","modules/clean/sharing/actions/sharing_actions","modules/clean/react/file_viewer/callout_utils"],function(e,t,n,o,a,r,i,s,m,l,c,d,p,u,g,_,h,f,b,v,w,T,E,y,C,S,M,P,A,O,k,I,D,U,x,N,R,V){"use strict";function F(e,t){return void 0===t&&(t=1),e===U.PreviewType.SsrDoc?{type:"document",regionType:"rectangle",regions:[n.__assign({page:t},C.createFullRectangle())]}:{type:"image",region:C.createFullRectangle()}}function L(e){var t=e.currentPageIndex,a=void 0===t?0:t,r=e.disabledTimeCodeTooltipComponent,i=e.playerCurrentTime,s=void 0===i?0:i,m=e.pendingNumberedAnnotation,l=e.playerIntegrationEnabled,c=e.previewType,d=e.upsellTooltipComponent;if(c===U.PreviewType.Audio||c===U.PreviewType.Video){var p=void 0;d?p=d:l||(p=r);var u=c===U.PreviewType.Audio?"audio":"video";return o.default.createElement(_.TimeCodedCommentEditor,n.__assign({},e,{pendingAnnotation:{type:u,time:s},tooltipComponent:p}))}return c===U.PreviewType.SsrDoc||c===U.PreviewType.Image?o.default.createElement(_.NumberedCommentEditor,n.__assign({},e,{defaultAnnotation:F(c,a+1),pendingAnnotation:m})):o.default.createElement(_.CommentEditor,n.__assign({},e))}Object.defineProperty(t,"__esModule",{value:!0}),o=n.__importDefault(o),a=n.__importStar(a),i=n.__importStar(i),m=n.__importDefault(m),p=n.__importStar(p),S=n.__importStar(S),k=n.__importStar(k),I=n.__importStar(I);var q=["image_preview_surface","document_preview_surface","how_to_at_mention_comments_pane_surface"],K=function(e){var t=e.children,n=e.markOnboarded,a=e.playerIntegrationEnabled,r=e.previewType,i=e.showOnboarding,s=a?"target-annotation":"target-mention",m=r!==U.PreviewType.Image&&r!==U.PreviewType.SsrDoc;return o.default.createElement(_.CoachMarkContainer,{className:s},t,m&&i&&!V.isPromptCalloutEnabled()&&o.default.createElement(w.CoachMark,{markOnboarded:n,playerIntegrationEnabled:a,previewType:r}))};t.createDefaultNumberedAnnotation=F;var Q=(function(a){function s(t){var s=a.call(this,t)||this;return s.mentionsQueryId=0,s.onCommentStreamRef=function(e){return s.commentStream=e},s.updateMentionsMatches=function(e){s.setState({mentionsMatches:e})},s.logMentionsQueryCompletedPerf=function(e){var t=I.mentionsQueryCompleted();s.props.dispatch(A.Actions.logPerfEvent(t,e))},s.onMentionsQueryUpdated=function(e){if(e){var t=++s.mentionsQueryId;s.mentionsApi.query(e,s.updateMentionsMatches,I.withTiming(s.updateMentionsMatches,function(e){s.mentionsQueryId===t&&s.logMentionsQueryCompletedPerf(e)}))}else""===e&&s.updateMentionsMatches(s.mentionsApi.getMatchesWithStarterSuggestions());s.props.dispatch(A.Actions.markOnboardedIfUnmarked("how_to_at_mention_comments_pane_surface"))},s.onPostSuccess=function(e,t){e.metadata&&e.metadata.some(function(e){return"mention"===e.type})&&R.SharingActions.listMembers({user:t,contentId:s.props.stream.id,isFolder:!1,url:s.props.stream.linkUrl,includeSeenState:!1})},s.showEmailVerifyModal=function(e){if(!s.props.hasShownAnyModalVariant||e!==M.ShowModalReason.EditorFocus){s.props.dispatch(A.Actions.markModalVariantShown(M.ModalVariant.EmailVerifyModal)),S.logEvent("email_verify_modal_shown",{stream:s.props.stream});var t=function(){S.logEvent("email_verify_flow_completed",{stream:s.props.stream})};r.EmailVerification.get_for_user(s.props.viewer).show_verify_modal(t,i.ADD_COMMENT)}},s.showSignUpModal=function(t){if((!s.props.hasShownAnyModalVariant||t!==M.ShowModalReason.EditorFocus)&&u.SHARED_LINK_REACT_AUTH_MODAL){var a=function(){return n.__awaiter(s,void 0,void 0,function(){var t,a,r,i,s=this;return n.__generator(this,function(m){switch(m.label){case 0:return[4,Promise.all([new Promise(function(t,n){e(["modules/clean/react/modal"],t,n)}).then(n.__importStar),new Promise(function(t,n){e(["modules/clean/auth/login_or_register/modal"],t,n)}).then(n.__importStar),new Promise(function(t,n){e(["modules/core/browser"],t,n)}).then(n.__importStar)])];case 1:return t=m.sent(),a=t[0].Modal,r=t[1].LoginOrRegisterModal,i=t[2],S.logEvent("sign_up_modal_shown",{stream:this.props.stream}),a.showInstance(o.default.createElement(r,{commentParams:{stream:this.props.stream,variant:c.CommentTextVariant.POST},downloadAction:null,id:"shared-link-default-comments-signup-modal",kind:c.LoginOrRegisterKind.COMMENT,onAuthenticateSuccess:function(){return i.reload()},onCancel:function(){return S.logEvent("sign_up_modal_dismissed",{stream:s.props.stream})},showAppleLogin:!1,signup_tag:"comments_shmodel_modal_register"})),[2]}})})};s.props.dispatch(A.Actions.markModalVariantShown(M.ModalVariant.SignUpModal)),a()}},s.dismissImagePreviewSurfaceOnboarding=function(){s.dismissOnboarding(),s.markOnboarded("image_preview_surface")},s.dismissDocumentPreviewSurfaceOnboarding=function(){s.dismissOnboarding(),s.markOnboarded("document_preview_surface")},s.dismissHowToAtMentionOnoarding=function(){s.dismissOnboarding(),s.markOnboarded("how_to_at_mention_comments_pane_surface")},s.createComment=function(e){switch(s.props.previewType){case U.PreviewType.Video:case U.PreviewType.Audio:return o.default.createElement(g.TimeCodedComment,n.__assign({},e,{playerIntegrationEnabled:s.props.playerIntegrationEnabled}));case U.PreviewType.Image:case U.PreviewType.SsrDoc:return o.default.createElement(g.NumberedComment,n.__assign({},e));default:return o.default.createElement(g.Comment,n.__assign({},e))}},s.createEditor=function(e){var t=s.props,a=t.currentPageIndex,r=t.pendingNumberedAnnotation,i=t.playerCurrentTime,m=t.playerIntegrationEnabled,l=t.previewType,c=t.showOnboarding,d=t.upsellTooltipVariant,p=d?s.createUpsellTooltip:void 0;return o.default.createElement(K,{markOnboarded:s.markOnboarded,playerIntegrationEnabled:m,previewType:l,showOnboarding:c},o.default.createElement(L,n.__assign({},e,{disabledTimeCodeTooltipComponent:s.createDisabledTimeCodeTooltip,upsellTooltipComponent:p,pendingNumberedAnnotation:r,currentPageIndex:a,playerIntegrationEnabled:m,playerCurrentTime:i,previewType:l})))},s.createDisabledTimeCodeTooltip=function(e){return o.default.createElement(N.DisabledTimeCodeTooltip,n.__assign({},e,{onClick:s.onDisabledTooltipLearnMoreClick,onShow:s.onDisabledTooltipShow}))},s.createUpsellTooltip=function(e){return o.default.createElement(N.UpsellTooltip,n.__assign({},e,{onClick:s.onUpsellTooltipClick,onDismiss:s.onUpsellTooltipDismiss,onShow:s.onUpsellTooltipShow,variant:s.props.upsellTooltipVariant,showUpsellExperiment:!s.props.collapsed&&s.props.showUpsellExperiment}))},s.onDisabledTooltipLearnMoreClick=function(){return S.logEvent("time_based_tooltip_learn_more_click",{stream:s.props.stream})},s.onDisabledTooltipShow=function(){return S.logEvent("time_based_tooltip_learn_more_view",{stream:s.props.stream})},s.onUpsellTooltipClick=function(){s.dismissUpsell(),S.logEvent("time_based_tooltip_upgrade_click",{stream:s.props.stream})},s.onUpsellTooltipDismiss=function(){s.dismissUpsell(),S.logEvent("time_based_tooltip_upgrade_dismiss",{stream:s.props.stream})},s.onUpsellTooltipShow=function(){return S.logEvent("time_based_tooltip_upgrade_view",{stream:s.props.stream})},s.markOnboarded=function(e){s.props.dispatch(A.Actions.markOnboarded(e))},s.dismissOnboarding=function(){s.props.dispatch(A.Actions.dismissOnboarding(null))},s.mentionsApi=D.mentionsApi(t.viewer),s.state={mentionsMatches:s.mentionsApi.cache},s}return n.__extends(s,a),s.prototype.componentDidMount=function(){var e=this.props,t=e.dispatch,n=e.showOnboarding,o=e.perfEvents,a=e.stream,r=+new Date;S.logEvent("show_comments",{stream:a}),t(A.Actions.logSimplePerfEvent("stream_displayed_ms",r-(o.listCompleteTime||0))),t(A.Actions.logSimplePerfEvent("comment_editor_tti_ms",r-(o.setContextTime||0))),n&&S.logEvent("sidebar_onboarding_shown",{stream:a})},s.prototype.componentDidUpdate=function(e){var t=e.requestEditorFocus,n=e.showOnboarding,o=this.props,a=o.showOnboarding,r=o.dispatch,i=o.requestEditorFocus,s=o.stream;!n&&a&&S.logEvent("sidebar_onboarding_shown",{stream:s}),!t&&i&&(this.commentStream.focusPrimaryEditor(),r(A.Actions.fulfillEditorFocusRequest()))},Object.defineProperty(s.prototype,"onboardingKeysToMarkOnThreadCreation",{get:function(){return p.difference(this.props.relevantOnboardingKeys,q)},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"imagePdfCoachmarkData",{get:function(){var e=this,t=this.props,a=t.showOnboarding,r=t.relevantOnboardingKeys,i=l._("Animation of annotating a file",{comment:"This is alt text for an animated gif"}),s=a&&p.head(p.intersection(q,r)),m={title:o.default.createElement("h2",{className:"sc-coachmark-title"}),body:o.default.createElement("p",null)};switch(s){case"document_preview_surface":return{location:f.CoachmarkLocations.BELOW_COMMENT_STREAM,component:function(t){return o.default.createElement(T.CommentsCoachmark,n.__assign({},t,{overrideArrowPlacement:"left",onClose:e.dismissDocumentPreviewSurfaceOnboarding}),o.default.createElement(y.Comments2OnboardingImage,{fileNamePrefix:"02_Comments2_PDFComments","aria-label":i}),d.reactFormat(l._("<title>Call it out</title> <body>Select an area on the file to highlight and comment.</body>"),m))}};case"image_preview_surface":return{location:f.CoachmarkLocations.BELOW_COMMENT_STREAM,component:function(t){return o.default.createElement(T.CommentsCoachmark,n.__assign({},t,{overrideArrowPlacement:"left",onClose:e.dismissImagePreviewSurfaceOnboarding}),o.default.createElement(y.Comments2OnboardingImage,{fileNamePrefix:"01_Comments2_ImageComment","aria-label":i}),d.reactFormat(l._("<title>Call it out</title> <body>Select an area on the image to highlight and comment.</body>"),m))}};case"how_to_at_mention_comments_pane_surface":return{location:f.CoachmarkLocations.ABOVE_COMMENT_STREAM,target:f.CoachmarkTargets.MAIN_EDITOR_MENTION_BUTTON,component:function(t){return o.default.createElement(T.CommentsCoachmark,n.__assign({},t,{onClose:e.dismissHowToAtMentionOnoarding}),o.default.createElement(y.Comments2OnboardingImage,{fileNamePrefix:"03_Comments_AtMentions_v1","aria-label":l._("Animation of mentioning a user",{comment:"This is alt text for an animated gif"})}),d.reactFormat(l._("<title>Get the feedback you need</title> <body>Tag someone to work together on this file.</body>"),m))}};default:return}},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"actionsAdapter",{get:function(){var e=this.props.fileSidebarDispatch;return v.createActionsAdapter(this.props,e,this.onboardingKeysToMarkOnThreadCreation,this.onMentionsQueryUpdated,this.onPostSuccess,this.showSignUpModal,this.showEmailVerifyModal)},enumerable:!0,configurable:!0}),s.prototype.dismissUpsell=function(){var e=C.inUpsellExperiment();this.props.showUpsellExperiment?this.props.dispatch(A.Actions.dismissUpsellExperiment(void 0)):e||this.props.dispatch(A.Actions.dismissUpsellTooltip(void 0))},s.prototype.stickerSetsToStickerPacks=function(e){return e.map(function(e){return{url:e.url,stickers:e.stickers,description:e.description,name:e.name,id:e.set_id}})},s.prototype.render=function(){var e,n=this.props,a=n.activeThreadId,r=n.collapsed,i=n.dispatch,s=n.editorIsEmpty,l=n.focusedThreadId,c=n.hoverThreadId,d=n.isMobile,p=n.showResolved,u=n.stream.id,g=n.threads,_=n.viewer,f=n.previewType,v=n.streamSettings,w=n.stickers,T=n.upsellTooltipVariant,y=g.filter(function(e){return p||!e.resolvedInfo});e=_?P.dbxUserToIUser(_):b.getGuestIUser();var S=f===U.PreviewType.Image||f===U.PreviewType.SsrDoc;return o.default.createElement("div",{className:m.default("comments-pane-wrapper",{"no-comment":d&&0===y.length,"comments-pane-wrapper-show-resolved":p,"comments-pane-wrapper-hide-resolved":!p,"comments-pane-wrapper-all-changes-saved":!g.some(function(e){return!!e.pending}),"comments-upsell-eligible":!!T,"comments-upsell-ineligible":!T})},d&&o.default.createElement(t.MobileCommentsTitle,{commentCount:y.length}),o.default.createElement(h.CommentStream,{ref:this.onCommentStreamRef,id:u,actionsAdapter:this.actionsAdapter,commentComponent:this.createComment,editorComponent:this.createEditor,enabled:!0,isMobile:d,mentionsMatches:this.state.mentionsMatches,settings:v,threads:y,user:e,activeThreadID:a,focusedThreadID:l,hoverThreadID:c,showUnreadPill:C.canShowUnreadPill(),localization:x.commentsMasterLocalization,collapsed:r,coachmarkData:this.imagePdfCoachmarkData,showRevisionInfo:S,stickerPacks:w&&this.stickerSetsToStickerPacks(w)}),o.default.createElement(E.SidebarListener,{dispatch:i,editorIsEmpty:s,stream:this.props.stream}))},s})(o.default.Component);t.CommentsPaneComponent=Q,t.MobileCommentsTitle=function(e){return o.default.createElement("div",{className:"comments-pane-wrapper__mobile-comments-title"},l._("Comments Â· %(count)d",{comment:"Title shown on top of web previews comments, indicating the number of comment threads"}).format({count:e.commentCount}))};var H=a.connect(function(e){var t=k.getContext(e),n=t.stream,o=t.viewer,a=k.getData(e),r=a.perfEvents,i=a.upsellExperimentNotDismissed,s=a.upsellTooltipVariant;return{activeThreadId:k.getActivatedThreadId(e),editorIsEmpty:k.getEditorIsEmpty(e),focusedThreadId:k.getFocusedThreadId(e),hasShownAnyModalVariant:k.getHasShownAnyModalVariant(e),hoverThreadId:k.getHoverThreadId(e),playerCurrentTime:k.getPlayerCurrentTime(e),playerIntegrationEnabled:k.getIsPlayerIntegrationEnabled(e),relevantOnboardingKeys:k.getUnmarkedOnboardingKeysRelevantToCurrentFile(e),showOnboarding:k.getShowOnboardingOnCommentsPane(e),showResolved:k.getShowResolved(e),canEnable:k.getCanEnable(e),isEnabled:k.isEnabled(e),canSubscribe:k.getCanSubscribe(e),isSubscribed:k.getIsSubscribed(e),pendingNumberedAnnotation:k.getPendingNumberedAnnotation(e),previewType:k.getPreviewTypeForCurrentFile(e),currentPageIndex:O.getCurrentPageIndex(e),showUpsellExperiment:C.inUpsellExperiment()&&i,stream:n,threads:k.getThreads(e),viewer:o,upsellTooltipVariant:s,perfEvents:r,requestEditorFocus:k.getIsEditorFocusRequested(e),streamSettings:k.getStreamSettings(e),stickers:k.getStickers(e)}})(Q);t.CommentsPane=s.requireCssWithComponent(H,["/static/js/comments2/index.web-vflARkr3t.css","/static/css/comments2-vflV_pg-R.css","/static/css/snackbar-vflDXRizz.css"])});
//# sourceMappingURL=comments_pane.min.js-vflqq4Goh.map